//go:build windows

package main

import (
	"fmt"
	"os"
	"sync/atomic"
	"syscall"

	"github.com/getlantern/systray"
	"golang.org/x/sys/windows/registry"
)

// iconData is a simple 16x16 ICO file (network/proxy icon)
var iconData = []byte{
	0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x10, 0x00, 0x00, 0x01, 0x00, 0x20, 0x00, 0x68, 0x04,
	0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x20, 0x00,
	0x00, 0x00, 0x01, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0x28, 0x3F, 0x7D,
	0xB8, 0x91, 0x3F, 0x7D, 0xB8, 0xE1, 0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D,
	0xB8, 0xE1, 0x3F, 0x7D, 0xB8, 0x91, 0x3F, 0x7D, 0xB8, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0x54, 0x3F, 0x7D, 0xB8, 0xF6, 0x42, 0x81, 0xBD, 0xFF,
	0x47, 0x88, 0xC5, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF, 0x47, 0x88, 0xC5, 0xFF,
	0x42, 0x81, 0xBD, 0xFF, 0x3F, 0x7D, 0xB8, 0xF6, 0x3F, 0x7D, 0xB8, 0x54, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0x91,
	0x42, 0x81, 0xBD, 0xFF, 0x47, 0x88, 0xC5, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF, 0x51, 0x96, 0xD3, 0xFF,
	0x56, 0x9D, 0xDA, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF,
	0x47, 0x88, 0xC5, 0xFF, 0x42, 0x81, 0xBD, 0xFF, 0x3F, 0x7D, 0xB8, 0x91, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0xE1, 0x47, 0x88, 0xC5, 0xFF,
	0x4C, 0x8F, 0xCC, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF,
	0x5B, 0xA4, 0xE1, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF,
	0x47, 0x88, 0xC5, 0xFF, 0x3F, 0x7D, 0xB8, 0xE1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3F, 0x7D, 0xB8, 0x28, 0x3F, 0x7D, 0xB8, 0xFD, 0x4C, 0x8F, 0xCC, 0xFF, 0x56, 0x9D, 0xDA, 0xFF,
	0x5B, 0xA4, 0xE1, 0xFF, 0x60, 0xAB, 0xE8, 0xFF, 0x65, 0xB2, 0xEF, 0xFF, 0x65, 0xB2, 0xEF, 0xFF,
	0x60, 0xAB, 0xE8, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF,
	0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D, 0xB8, 0x28, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0x91,
	0x42, 0x81, 0xBD, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x60, 0xAB, 0xE8, 0xFF,
	0x65, 0xB2, 0xEF, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x65, 0xB2, 0xEF, 0xFF,
	0x60, 0xAB, 0xE8, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x42, 0x81, 0xBD, 0xFF,
	0x3F, 0x7D, 0xB8, 0x91, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0xE1, 0x47, 0x88, 0xC5, 0xFF,
	0x56, 0x9D, 0xDA, 0xFF, 0x60, 0xAB, 0xE8, 0xFF, 0x65, 0xB2, 0xEF, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF,
	0x6F, 0xC0, 0xFD, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x65, 0xB2, 0xEF, 0xFF,
	0x60, 0xAB, 0xE8, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x47, 0x88, 0xC5, 0xFF, 0x3F, 0x7D, 0xB8, 0xE1,
	0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0xFD, 0x4C, 0x8F, 0xCC, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF,
	0x65, 0xB2, 0xEF, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF,
	0x6F, 0xC0, 0xFD, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x65, 0xB2, 0xEF, 0xFF,
	0x5B, 0xA4, 0xE1, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF, 0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D, 0xB8, 0xFD,
	0x4C, 0x8F, 0xCC, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x65, 0xB2, 0xEF, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF,
	0x6F, 0xC0, 0xFD, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF,
	0x6A, 0xB9, 0xF6, 0xFF, 0x65, 0xB2, 0xEF, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF,
	0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D, 0xB8, 0xE1, 0x47, 0x88, 0xC5, 0xFF, 0x56, 0x9D, 0xDA, 0xFF,
	0x60, 0xAB, 0xE8, 0xFF, 0x65, 0xB2, 0xEF, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF,
	0x6F, 0xC0, 0xFD, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x65, 0xB2, 0xEF, 0xFF, 0x60, 0xAB, 0xE8, 0xFF,
	0x56, 0x9D, 0xDA, 0xFF, 0x47, 0x88, 0xC5, 0xFF, 0x3F, 0x7D, 0xB8, 0xE1, 0x3F, 0x7D, 0xB8, 0x91,
	0x42, 0x81, 0xBD, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x60, 0xAB, 0xE8, 0xFF,
	0x65, 0xB2, 0xEF, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x65, 0xB2, 0xEF, 0xFF,
	0x60, 0xAB, 0xE8, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x42, 0x81, 0xBD, 0xFF,
	0x3F, 0x7D, 0xB8, 0x91, 0x3F, 0x7D, 0xB8, 0x28, 0x3F, 0x7D, 0xB8, 0xFD, 0x4C, 0x8F, 0xCC, 0xFF,
	0x56, 0x9D, 0xDA, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x60, 0xAB, 0xE8, 0xFF, 0x65, 0xB2, 0xEF, 0xFF,
	0x65, 0xB2, 0xEF, 0xFF, 0x60, 0xAB, 0xE8, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x56, 0x9D, 0xDA, 0xFF,
	0x4C, 0x8F, 0xCC, 0xFF, 0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D, 0xB8, 0x28, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0xE1, 0x47, 0x88, 0xC5, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF,
	0x51, 0x96, 0xD3, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF,
	0x56, 0x9D, 0xDA, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF, 0x47, 0x88, 0xC5, 0xFF,
	0x3F, 0x7D, 0xB8, 0xE1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3F, 0x7D, 0xB8, 0x91, 0x42, 0x81, 0xBD, 0xFF, 0x47, 0x88, 0xC5, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF,
	0x51, 0x96, 0xD3, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x51, 0x96, 0xD3, 0xFF,
	0x4C, 0x8F, 0xCC, 0xFF, 0x47, 0x88, 0xC5, 0xFF, 0x42, 0x81, 0xBD, 0xFF, 0x3F, 0x7D, 0xB8, 0x91,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3F, 0x7D, 0xB8, 0x54, 0x3F, 0x7D, 0xB8, 0xF6, 0x42, 0x81, 0xBD, 0xFF, 0x47, 0x88, 0xC5, 0xFF,
	0x4C, 0x8F, 0xCC, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF, 0x47, 0x88, 0xC5, 0xFF, 0x42, 0x81, 0xBD, 0xFF,
	0x3F, 0x7D, 0xB8, 0xF6, 0x3F, 0x7D, 0xB8, 0x54, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3F, 0x7D, 0xB8, 0x28, 0x3F, 0x7D, 0xB8, 0x91, 0x3F, 0x7D, 0xB8, 0xE1, 0x3F, 0x7D, 0xB8, 0xFD,
	0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D, 0xB8, 0xE1, 0x3F, 0x7D, 0xB8, 0x91, 0x3F, 0x7D, 0xB8, 0x28,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
}

var (
	kernel32        = syscall.NewLazyDLL("kernel32.dll")
	procAllocConsole = kernel32.NewProc("AllocConsole")
	procFreeConsole  = kernel32.NewProc("FreeConsole")
	procGetConsoleWindow = kernel32.NewProc("GetConsoleWindow")
	
	user32           = syscall.NewLazyDLL("user32.dll")
	procShowWindow   = user32.NewProc("ShowWindow")
)

const (
	SW_HIDE = 0
	SW_SHOW = 5
)

var consoleVisible atomic.Bool

func init() {
	consoleVisible.Store(true)
}

func getConsoleWindow() (uintptr, error) {
	hwnd, _, err := procGetConsoleWindow.Call()
	if hwnd == 0 {
		return 0, err
	}
	return hwnd, nil
}

func hideConsole() error {
	hwnd, err := getConsoleWindow()
	if err != nil {
		return err
	}
	ret, _, err := procShowWindow.Call(hwnd, SW_HIDE)
	if ret == 0 {
		return err
	}
	consoleVisible.Store(false)
	return nil
}

func showConsole() error {
	hwnd, err := getConsoleWindow()
	if err != nil {
		return err
	}
	ret, _, err := procShowWindow.Call(hwnd, SW_SHOW)
	if ret == 0 {
		return err
	}
	consoleVisible.Store(true)
	return nil
}

func toggleConsole() {
	if consoleVisible.Load() {
		if err := hideConsole(); err != nil {
			// Log error but continue
		}
	} else {
		if err := showConsole(); err != nil {
			// Log error but continue
		}
	}
}

// Proxy configuration
var (
	proxyEnabled  atomic.Bool
	socks5Address string
	httpAddress   string

	wininet = syscall.NewLazyDLL("wininet.dll")
	procInternetSetOptionW = wininet.NewProc("InternetSetOptionW")
)

const (
	INTERNET_OPTION_SETTINGS_CHANGED = 39
	INTERNET_OPTION_REFRESH          = 37
)

// setSystemProxy sets the Windows system proxy to use lumine
func setSystemProxy() error {
	key, err := registry.OpenKey(registry.CURRENT_USER, 
		`Software\Microsoft\Windows\CurrentVersion\Internet Settings`, 
		registry.SET_VALUE)
	if err != nil {
		return fmt.Errorf("failed to open registry key: %w", err)
	}
	defer key.Close()

	// Enable proxy
	if err := key.SetDWordValue("ProxyEnable", 1); err != nil {
		return fmt.Errorf("failed to enable proxy: %w", err)
	}

	// Set proxy server address
	// Format: http=host:port;https=host:port;socks=host:port
	proxyServer := fmt.Sprintf("http=%s;https=%s;socks=%s", httpAddress, httpAddress, socks5Address)
	if err := key.SetStringValue("ProxyServer", proxyServer); err != nil {
		return fmt.Errorf("failed to set proxy server: %w", err)
	}

	// Notify system of proxy changes
	notifyProxyChange()

	proxyEnabled.Store(true)
	return nil
}

// unsetSystemProxy disables the Windows system proxy
func unsetSystemProxy() error {
	key, err := registry.OpenKey(registry.CURRENT_USER, 
		`Software\Microsoft\Windows\CurrentVersion\Internet Settings`, 
		registry.SET_VALUE)
	if err != nil {
		return fmt.Errorf("failed to open registry key: %w", err)
	}
	defer key.Close()

	// Disable proxy
	if err := key.SetDWordValue("ProxyEnable", 0); err != nil {
		return fmt.Errorf("failed to disable proxy: %w", err)
	}

	// Notify system of proxy changes
	notifyProxyChange()

	proxyEnabled.Store(false)
	return nil
}

// notifyProxyChange notifies Windows that proxy settings have changed
func notifyProxyChange() {
	ret1, _, _ := procInternetSetOptionW.Call(0, INTERNET_OPTION_SETTINGS_CHANGED, 0, 0)
	if ret1 == 0 {
		fmt.Println("Warning: Failed to notify Windows of proxy settings change")
	}
	ret2, _, _ := procInternetSetOptionW.Call(0, INTERNET_OPTION_REFRESH, 0, 0)
	if ret2 == 0 {
		fmt.Println("Warning: Failed to refresh proxy settings")
	}
}

// checkProxyStatus checks if the system proxy is currently enabled
func checkProxyStatus() bool {
	key, err := registry.OpenKey(registry.CURRENT_USER, 
		`Software\Microsoft\Windows\CurrentVersion\Internet Settings`, 
		registry.QUERY_VALUE)
	if err != nil {
		return false
	}
	defer key.Close()

	enabled, _, err := key.GetIntegerValue("ProxyEnable")
	if err != nil {
		return false
	}

	return enabled == 1
}

func onReady() {
	systray.SetIcon(iconData)
	systray.SetTitle("Lumine Proxy")
	systray.SetTooltip("Lumine HTTP/SOCKS5 Proxy Server")

	// Check initial proxy status
	if checkProxyStatus() {
		proxyEnabled.Store(true)
	}

	mToggle := systray.AddMenuItem("Show/Hide Console", "Toggle console window visibility")
	systray.AddSeparator()

	mSetProxy := systray.AddMenuItem("Set System Proxy", "Configure Windows to use Lumine proxy")
	mUnsetProxy := systray.AddMenuItem("Unset System Proxy", "Remove Windows proxy configuration")

	// Update menu item states based on current proxy status
	if proxyEnabled.Load() {
		mSetProxy.Disable()
		mUnsetProxy.Enable()
	} else {
		mSetProxy.Enable()
		mUnsetProxy.Disable()
	}

	systray.AddSeparator()
	mQuit := systray.AddMenuItem("Exit", "Exit the application")

	go func() {
		for {
			select {
			case <-mToggle.ClickedCh:
				toggleConsole()
			case <-mSetProxy.ClickedCh:
				if err := setSystemProxy(); err != nil {
					// Log error but continue
					fmt.Printf("Failed to set system proxy: %v\n", err)
				} else {
					mSetProxy.Disable()
					mUnsetProxy.Enable()
				}
			case <-mUnsetProxy.ClickedCh:
				if err := unsetSystemProxy(); err != nil {
					// Log error but continue
					fmt.Printf("Failed to unset system proxy: %v\n", err)
				} else {
					mSetProxy.Enable()
					mUnsetProxy.Disable()
				}
			case <-mQuit.ClickedCh:
				systray.Quit()
				return
			}
		}
	}()
}

func onExit() {
	// Cleanup code
	showConsole()
}

func runWithSystray(socks5Addr, httpAddr string, mainFunc func()) {
	// Store proxy addresses for system proxy configuration
	socks5Address = socks5Addr
	httpAddress = httpAddr

	// Hide console on startup when in GUI mode
	hideConsole()

	// Start the main proxy server in a goroutine
	go mainFunc()

	// Run systray - this blocks until Quit is called
	systray.Run(onReady, onExit)

	// After systray.Quit(), exit the application
	os.Exit(0)
}
