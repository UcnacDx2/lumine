//go:build windows

package main

import (
	"os"
	"syscall"

	"github.com/getlantern/systray"
)

// iconData is a simple 16x16 ICO file (network/proxy icon)
var iconData = []byte{
	0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x10, 0x10, 0x00, 0x00, 0x01, 0x00, 0x20, 0x00, 0x68, 0x04,
	0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x20, 0x00,
	0x00, 0x00, 0x01, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0x28, 0x3F, 0x7D,
	0xB8, 0x91, 0x3F, 0x7D, 0xB8, 0xE1, 0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D,
	0xB8, 0xE1, 0x3F, 0x7D, 0xB8, 0x91, 0x3F, 0x7D, 0xB8, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0x54, 0x3F, 0x7D, 0xB8, 0xF6, 0x42, 0x81, 0xBD, 0xFF,
	0x47, 0x88, 0xC5, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF, 0x47, 0x88, 0xC5, 0xFF,
	0x42, 0x81, 0xBD, 0xFF, 0x3F, 0x7D, 0xB8, 0xF6, 0x3F, 0x7D, 0xB8, 0x54, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0x91,
	0x42, 0x81, 0xBD, 0xFF, 0x47, 0x88, 0xC5, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF, 0x51, 0x96, 0xD3, 0xFF,
	0x56, 0x9D, 0xDA, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF,
	0x47, 0x88, 0xC5, 0xFF, 0x42, 0x81, 0xBD, 0xFF, 0x3F, 0x7D, 0xB8, 0x91, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0xE1, 0x47, 0x88, 0xC5, 0xFF,
	0x4C, 0x8F, 0xCC, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF,
	0x5B, 0xA4, 0xE1, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF,
	0x47, 0x88, 0xC5, 0xFF, 0x3F, 0x7D, 0xB8, 0xE1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3F, 0x7D, 0xB8, 0x28, 0x3F, 0x7D, 0xB8, 0xFD, 0x4C, 0x8F, 0xCC, 0xFF, 0x56, 0x9D, 0xDA, 0xFF,
	0x5B, 0xA4, 0xE1, 0xFF, 0x60, 0xAB, 0xE8, 0xFF, 0x65, 0xB2, 0xEF, 0xFF, 0x65, 0xB2, 0xEF, 0xFF,
	0x60, 0xAB, 0xE8, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF,
	0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D, 0xB8, 0x28, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0x91,
	0x42, 0x81, 0xBD, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x60, 0xAB, 0xE8, 0xFF,
	0x65, 0xB2, 0xEF, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x65, 0xB2, 0xEF, 0xFF,
	0x60, 0xAB, 0xE8, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x42, 0x81, 0xBD, 0xFF,
	0x3F, 0x7D, 0xB8, 0x91, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0xE1, 0x47, 0x88, 0xC5, 0xFF,
	0x56, 0x9D, 0xDA, 0xFF, 0x60, 0xAB, 0xE8, 0xFF, 0x65, 0xB2, 0xEF, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF,
	0x6F, 0xC0, 0xFD, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x65, 0xB2, 0xEF, 0xFF,
	0x60, 0xAB, 0xE8, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x47, 0x88, 0xC5, 0xFF, 0x3F, 0x7D, 0xB8, 0xE1,
	0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0xFD, 0x4C, 0x8F, 0xCC, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF,
	0x65, 0xB2, 0xEF, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF,
	0x6F, 0xC0, 0xFD, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x65, 0xB2, 0xEF, 0xFF,
	0x5B, 0xA4, 0xE1, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF, 0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D, 0xB8, 0xFD,
	0x4C, 0x8F, 0xCC, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x65, 0xB2, 0xEF, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF,
	0x6F, 0xC0, 0xFD, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF,
	0x6A, 0xB9, 0xF6, 0xFF, 0x65, 0xB2, 0xEF, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF,
	0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D, 0xB8, 0xE1, 0x47, 0x88, 0xC5, 0xFF, 0x56, 0x9D, 0xDA, 0xFF,
	0x60, 0xAB, 0xE8, 0xFF, 0x65, 0xB2, 0xEF, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x6F, 0xC0, 0xFD, 0xFF,
	0x6F, 0xC0, 0xFD, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x65, 0xB2, 0xEF, 0xFF, 0x60, 0xAB, 0xE8, 0xFF,
	0x56, 0x9D, 0xDA, 0xFF, 0x47, 0x88, 0xC5, 0xFF, 0x3F, 0x7D, 0xB8, 0xE1, 0x3F, 0x7D, 0xB8, 0x91,
	0x42, 0x81, 0xBD, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x60, 0xAB, 0xE8, 0xFF,
	0x65, 0xB2, 0xEF, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x6A, 0xB9, 0xF6, 0xFF, 0x65, 0xB2, 0xEF, 0xFF,
	0x60, 0xAB, 0xE8, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x42, 0x81, 0xBD, 0xFF,
	0x3F, 0x7D, 0xB8, 0x91, 0x3F, 0x7D, 0xB8, 0x28, 0x3F, 0x7D, 0xB8, 0xFD, 0x4C, 0x8F, 0xCC, 0xFF,
	0x56, 0x9D, 0xDA, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x60, 0xAB, 0xE8, 0xFF, 0x65, 0xB2, 0xEF, 0xFF,
	0x65, 0xB2, 0xEF, 0xFF, 0x60, 0xAB, 0xE8, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x56, 0x9D, 0xDA, 0xFF,
	0x4C, 0x8F, 0xCC, 0xFF, 0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D, 0xB8, 0x28, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x3F, 0x7D, 0xB8, 0xE1, 0x47, 0x88, 0xC5, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF,
	0x51, 0x96, 0xD3, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF, 0x5B, 0xA4, 0xE1, 0xFF,
	0x56, 0x9D, 0xDA, 0xFF, 0x51, 0x96, 0xD3, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF, 0x47, 0x88, 0xC5, 0xFF,
	0x3F, 0x7D, 0xB8, 0xE1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3F, 0x7D, 0xB8, 0x91, 0x42, 0x81, 0xBD, 0xFF, 0x47, 0x88, 0xC5, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF,
	0x51, 0x96, 0xD3, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x56, 0x9D, 0xDA, 0xFF, 0x51, 0x96, 0xD3, 0xFF,
	0x4C, 0x8F, 0xCC, 0xFF, 0x47, 0x88, 0xC5, 0xFF, 0x42, 0x81, 0xBD, 0xFF, 0x3F, 0x7D, 0xB8, 0x91,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3F, 0x7D, 0xB8, 0x54, 0x3F, 0x7D, 0xB8, 0xF6, 0x42, 0x81, 0xBD, 0xFF, 0x47, 0x88, 0xC5, 0xFF,
	0x4C, 0x8F, 0xCC, 0xFF, 0x4C, 0x8F, 0xCC, 0xFF, 0x47, 0x88, 0xC5, 0xFF, 0x42, 0x81, 0xBD, 0xFF,
	0x3F, 0x7D, 0xB8, 0xF6, 0x3F, 0x7D, 0xB8, 0x54, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x3F, 0x7D, 0xB8, 0x28, 0x3F, 0x7D, 0xB8, 0x91, 0x3F, 0x7D, 0xB8, 0xE1, 0x3F, 0x7D, 0xB8, 0xFD,
	0x3F, 0x7D, 0xB8, 0xFD, 0x3F, 0x7D, 0xB8, 0xE1, 0x3F, 0x7D, 0xB8, 0x91, 0x3F, 0x7D, 0xB8, 0x28,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
}

var (
	kernel32        = syscall.NewLazyDLL("kernel32.dll")
	procAllocConsole = kernel32.NewProc("AllocConsole")
	procFreeConsole  = kernel32.NewProc("FreeConsole")
	procGetConsoleWindow = kernel32.NewProc("GetConsoleWindow")
	
	user32           = syscall.NewLazyDLL("user32.dll")
	procShowWindow   = user32.NewProc("ShowWindow")
)

const (
	SW_HIDE = 0
	SW_SHOW = 5
)

var consoleVisible = true

func getConsoleWindow() (uintptr, error) {
	hwnd, _, err := procGetConsoleWindow.Call()
	if hwnd == 0 {
		return 0, err
	}
	return hwnd, nil
}

func hideConsole() error {
	hwnd, err := getConsoleWindow()
	if err != nil {
		return err
	}
	procShowWindow.Call(hwnd, SW_HIDE)
	consoleVisible = false
	return nil
}

func showConsole() error {
	hwnd, err := getConsoleWindow()
	if err != nil {
		return err
	}
	procShowWindow.Call(hwnd, SW_SHOW)
	consoleVisible = true
	return nil
}

func toggleConsole() {
	if consoleVisible {
		hideConsole()
	} else {
		showConsole()
	}
}

func onReady() {
	systray.SetIcon(iconData)
	systray.SetTitle("Lumine Proxy")
	systray.SetTooltip("Lumine HTTP/SOCKS5 Proxy Server")

	mToggle := systray.AddMenuItem("Show/Hide Console", "Toggle console window visibility")
	systray.AddSeparator()
	mQuit := systray.AddMenuItem("Exit", "Exit the application")

	go func() {
		for {
			select {
			case <-mToggle.ClickedCh:
				toggleConsole()
			case <-mQuit.ClickedCh:
				systray.Quit()
				return
			}
		}
	}()
}

func onExit() {
	// Cleanup code
	showConsole()
}

func runWithSystray(mainFunc func()) {
	// Hide console on startup when in GUI mode
	hideConsole()
	
	// Start the main proxy server in a goroutine
	go mainFunc()
	
	// Run systray - this blocks until Quit is called
	systray.Run(onReady, onExit)
	
	// After systray.Quit(), exit the application
	os.Exit(0)
}
